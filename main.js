document.addEventListener('DOMContentLoaded', function () {


    var result =

        [
            {
                "id": "9NVIBHDJ0U1UIVAFWVYC",
                "label": "alignment",
                "displaySyntax": "alignment",
                "syntax": "this.tempObject('dummy_data.widget.text.alignment')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "string",
                "storeType": "tempObject",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.tempObject.dummy_data.widget.text.alignment",
                'innerHTML': '<span class="IntelliTextEditor-argument">this.tempObject(\'dummy_data.widget.text.alignment\')</span>'
            },
            {
                "id": "B1LX7EYVE5PGH23OMD5R",
                "label": "hOffset",
                "displaySyntax": "hOffset",
                "syntax": "this.workVariable('dummy_data2.image.hOffset')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "number",
                "storeType": "workVar",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.workVar.dummy_data2.image.hOffset"
            },
            {
                "id": "8GYLD2IV7APMKPBBBZRJ",
                "label": "name",
                "displaySyntax": "name",
                "syntax": "this.tempObject('two.name')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "26314113394031325343",
                "returnType": "string",
                "storeType": "tempObject",
                "path": "Sha_GD8_RS.Sha_C19_RS.two.tempObject.two.name"
            },
            {
                "id": "C1IVBNBTW4HGAK87KE4D",
                "label": "text",
                "displaySyntax": "text",
                "syntax": "this.tempObject('dummy_data.widget.text')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "object",
                "storeType": "tempObject",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.tempObject.dummy_data.widget.text"
            },
            {
                "id": "43NVI3Z63FDDINSINIBF",
                "label": "data",
                "displaySyntax": "data",
                "syntax": "this.tempObject('dummy_data.widget.text.data')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "string",
                "storeType": "tempObject",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.tempObject.dummy_data.widget.text.data"
            },
            {
                "id": "NJLAAAAHYUIXD4LKX7X3",
                "label": "name",
                "displaySyntax": "name",
                "syntax": "this.tempObject('dummy_data.widget.text.name')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "string",
                "storeType": "tempObject",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.tempObject.dummy_data.widget.text.name"
            },
            {
                "id": "A81J1ULQOW8IHDZ7ML4L",
                "label": "size",
                "displaySyntax": "size",
                "syntax": "this.tempObject('dummy_data.widget.text.size')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "number",
                "storeType": "tempObject",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.tempObject.dummy_data.widget.text.size"
            },
            {
                "id": "BLVMAZ56ZRVPYXDR2HP6",
                "label": "onMouseUp",
                "displaySyntax": "onMouseUp",
                "syntax": "this.tempObject('dummy_data.widget.text.onMouseUp')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "string",
                "storeType": "tempObject",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.tempObject.dummy_data.widget.text.onMouseUp"
            },
            {
                "id": "HH2VGF6M9S7TLCKYWGS5",
                "label": "src",
                "displaySyntax": "src",
                "syntax": "this.workVariable('dummy_data2.image.src')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "string",
                "storeType": "workVar",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.workVar.dummy_data2.image.src"
            },
            {
                "id": "78DLIDZ9UKVOIQMWY87M",
                "label": "vOffset",
                "displaySyntax": "vOffset",
                "syntax": "this.workVariable('dummy_data2.image.vOffset')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "number",
                "storeType": "workVar",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.workVar.dummy_data2.image.vOffset"
            },
            {
                "id": "3KQP3LZHT76C0JQATKLA",
                "label": "hello",
                "displaySyntax": "hello",
                "syntax": "this.tempObject('dummy_data.widget.text.hello')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "string",
                "storeType": "tempObject",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.tempObject.dummy_data.widget.text.hello"
            },
            {
                "id": "LD0N4L9J1414NHU1AXJS",
                "label": "style",
                "displaySyntax": "style",
                "syntax": "this.tempObject('dummy_data.widget.text.style')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "string",
                "storeType": "tempObject",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.tempObject.dummy_data.widget.text.style"
            },
            {
                "id": "7EKIFCKCL7OLJ9EOKJN5",
                "label": "alignment",
                "displaySyntax": "alignment",
                "syntax": "this.workVariable('dummy_data2.image.alignment')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "string",
                "storeType": "workVar",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.workVar.dummy_data2.image.alignment"
            },
            {
                "id": "B7GKT3OMZJQ61MOS95S5",
                "label": "widget",
                "displaySyntax": "widget",
                "syntax": "this.tempObject('dummy_data.widget')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "object",
                "storeType": "tempObject",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.tempObject.dummy_data.widget"
            },
            {
                "id": "NEO401SM7IJ6OV1H2ERL",
                "label": "hOffset",
                "displaySyntax": "hOffset",
                "syntax": "this.tempObject('dummy_data.widget.text.hOffset')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "number",
                "storeType": "tempObject",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.tempObject.dummy_data.widget.text.hOffset"
            },
            {
                "id": "4YK8DDTVOJJZFUIE5EQG",
                "label": "vOffset",
                "displaySyntax": "vOffset",
                "syntax": "this.tempObject('dummy_data.widget.text.vOffset')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "number",
                "storeType": "tempObject",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.tempObject.dummy_data.widget.text.vOffset"
            },
            {
                "id": "1OSTD0IUV1QATFXDYNB2",
                "label": "image",
                "displaySyntax": "image",
                "syntax": "this.workVariable('dummy_data2.image')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "object",
                "storeType": "workVar",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.workVar.dummy_data2.image"
            },
            {
                "id": "QR9I2VL8663I2B2CJLQ1",
                "label": "name",
                "displaySyntax": "name",
                "syntax": "this.workVariable('dummy_data2.image.name')",
                "type": "ATTRIBUTE",
                "description": "",
                "hint": "",
                "workspaceId": "91817431040120303690",
                "returnType": "string",
                "storeType": "workVar",
                "path": "Vip_BFT_RS.Vip_OLI_RS.Coll_3.workVar.dummy_data2.image.name"
            }
        ].map(function (val) {
            val['innerHTML'] = '<span class="IntelliTextEditor-argument">' + val.syntax + '</span>';
            return val;
        })

    console.log(result);;


    const DEFINITION = {
        'ARGUMENT': 0,
        'FUNCTION': 1,
        'SEPARATOR': 2
    }

    const HTMLCLASSCONSTANTS = {
        'IntelliTextEditor-argument': DEFINITION.ARGUMENT,
        'IntelliTextEditor-function': DEFINITION.FUNCTION,
        'IntelliTextEditor-separator': DEFINITION.SEPARATOR
    }

    var suggestionUlElem = document.querySelector('#intelli-vhn-cd-007');
    var topDiv = document.querySelector('.IntelliTextEditor');
    // function cursor_position() {
    //     var sel = document.getSelection();

    //     var pos = sel.toString().length;
    //     if (sel.anchorNode != undefined) sel.collapseToEnd();

    //     return pos;
    // }

    // // Demo:
    // // var elm = document.querySelector('[contenteditable]');
    // topDiv.addEventListener('click', printCaretPosition)
    // topDiv.addEventListener('keydown', printCaretPosition)

    // function printCaretPosition() {
    //     console.log(cursor_position(), 'length:', this.textContent.trim().length)
    // }
    var selectedSpan;



    function handleClickEvent(event) {
        console.dir(event.target);

        // Can add if not selected near closing bracket otherwise hole funtion get selected
        if (event.target.className != 'IntelliTextEditor refreshing')
            addRange(event.target);

        // var selection = window.getSelection();

        // console.dir(selection);

        // const node = document.createElement('span');
        // node.textContent = 'HELLO';

        // document.getSelection().anchorNode.appendChild(node)
        // topDiv.replaceChild(node, document.getSelection())


        let className = event.target.className;

        if (HTMLCLASSCONSTANTS.hasOwnProperty(className)) {
            className = HTMLCLASSCONSTANTS[className];
            let targetNode = event.target.nodeName;

            if (targetNode == 'SPAN') {
                selectedSpan = event.target;
                if (className == DEFINITION.ARGUMENT) {
                    displaySuggestion('*'); // ARG
                } else if (className == DEFINITION.FUNCTION) { // FUNC
                    displaySuggestion('*');
                } else if (className == DEFINITION.SEPARATOR) {

                }

                // removeAllHighligh();
                // event.target.classList.add('highlight');
            } else {
                selectedSpan = undefined;
                displaySuggestion('*');
            }

        }




    }

    function handleKeyUpEvent(event) {
        if (event.code.toLowerCase() == 'space') {
            const span = document.createElement('span');
            span.textContent = event.key;

            event.parentNode.insertAdjecentHTML('afterend', '<span> </span>')
            // const selection = window.getSelection();
            // console.dir(selection);
            // const range = selection.getRangeAt(0);

            // // range.commonAncestorContainer.firstElementChild.insertNode(span)
            // console.dir(range);
            // range.insertNode(span);
        }

    }

    function handleSuggestionClick(event) {
        var targetLi = event.target.closest('.list');
        var selectedOption = null;
        if (targetLi.classList.contains('FUNC')) {
            selectedOption = window.FUNCTIONS.find((func) => func.id == targetLi.dataset.id);
        } else if (targetLi.classList.contains('ARG')) {
            selectedOption = window.ATTRIBUTES.find((func) => func.id == targetLi.dataset.id);
        }

        let dummyTag = createDummyTag(selectedOption.innerHTML);

        selectedSpan && selectedSpan.parentNode.replaceChild(dummyTag.firstChild, selectedSpan);
    }

    function createDummyTag(value) {
        const div = document.createElement('div');
        div.innerHTML = value;
        return div;
    }



    // /**Handlers */
    topDiv.addEventListener('click', handleClickEvent);
    topDiv.addEventListener('keyup', handleKeyUpEvent);
    suggestionUlElem.addEventListener('click', handleSuggestionClick);




    // const handleKeyboard = (event) => {
    //     // console.log(ctrlKey);
    //     // if (repeat) return
    //     // if ((metaKey || 'Control') && key === ' ') console.log('’Cmd+/’ was pressed')

    //     console.dir(event);
    // }


    // topDiv.addEventListener('keyup', handleKeyboard);


    function getAttriute(text) {
        return `<span class="IntelliTextEditor-target">${text}</span>`;
    }




    function displaySuggestion(type) {
        suggestionUlElem.innerHTML = '';

        if (type == '*') {
            showList(type);
        } else if (type == 'ARG') {
            showList('ARG')
        } else if (type == 'FUNC') {
            showList('FUNC');
        }
    }

    function showList(type) {
        if (type == '*') {
            window.FUNCTIONS.forEach((func) => {
                suggestionUlElem.insertAdjacentHTML('beforeend', makeLst('FUNC', func));
            })

            window.ATTRIBUTES.forEach((func) => {
                suggestionUlElem.insertAdjacentHTML('beforeend', makeLst('ARG', func));
            })

        } else if (type == 'FUNC') {
            window.FUNCTIONS.forEach((func) => {
                suggestionUlElem.insertAdjacentHTML('beforeend', makeLst(type, func));
            })
        } else if (type == 'ARG') {
            window.ATTRIBUTES.forEach((func) => {
                suggestionUlElem.insertAdjacentHTML('beforeend', makeLst(type, func));
            })
        }

    }

    function makeLst(type, obj) {
        return `<li class="list ${type}" data-id="${obj.id}">
                    <span></span>
                    ${obj.syntax}
                </li>`
    }



    /**
     * Helper Method
     */

    function addRange(element) {
        let selection = window.getSelection();
        let range = document.createRange();

        if (selection.rangeCount > 0) {
            selection.removeAllRanges();
        }

        range.selectNode(element);
        selection.addRange(range);
    }

    function removeAllHighligh() {
        const allHighlightedElems = document.querySelectorAll('span.highlight');
        allHighlightedElems.forEach(highlightElem => {
            highlightElem.classList.remove('highlight');
        });
    }


    function createAttributeSpan(attrcObj) {
        const span = document.createElement('span');
        span.classList.add('IntelliTextEditor-argument');
        span.innerText = attrcObj.syntax;

        return span;
    }




    /**
     * Testing::
     */


    // let button = document.querySelector('button');

    // button.addEventListener('click', function () {
    //     debugger
    //     let selection = window.getSelection();
    //     let strongs = document.getElementsByTagName('strong');

    //     if (selection.rangeCount > 0) {
    //         selection.removeAllRanges();
    //     }

    //     for (let i = 0; i < strongs.length; i++) {
    //         let range = document.createRange();
    //         range.selectNode(strongs[i]);
    //         selection.addRange(range);
    //     }
    // });




})